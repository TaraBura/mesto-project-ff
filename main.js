(()=>{"use strict";const e={baseUrl:"https://nomoreparties.co/v1/wff-cohort-22",headers:{authorization:"dd1dbf2c-5beb-4ecd-b2da-38506ca41c18","Content-Type":"application/json"}};function t(e){return e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`)}function r(r,o,c,a,s){const l=o.querySelector(".card");if(!l)return console.error("Элемент с классом .card не найден в шаблоне."),null;const i=l.cloneNode(!0),d=i.querySelector(".card__delete-button"),u=i.querySelector(".card__like-button"),p=i.querySelector(".card__image"),_=i.querySelector(".card__title"),m=i.querySelector(".like__counter");return p?(p.src=r.link,p.alt=r.name,p.addEventListener("click",c)):console.error("Элемент с классом .card__image не найден в карточке."),_?_.textContent=r.name:console.error("Элемент с классом .card__title не найден в карточке."),m?m.textContent=r.likes.length:console.error("Элемент с классом .like__counter не найден в карточке."),u?(u.dataset.id=r._id,u.addEventListener("click",n),r.likes.some((e=>e._id===a))&&u.classList.add("card__like-button_is-active")):console.error("Элемент с классом .card__like-button не найден в карточке."),d?(r.owner._id!==a&&d.classList.add("card__delete-button--hidden"),r.owner._id===a&&d.addEventListener("click",(()=>s(r._id,(()=>{return n=r._id,fetch(`${e.baseUrl}/cards/${n}`,{method:"DELETE",headers:e.headers}).then((e=>t(e)));var n}),i)))):console.error("Элемент с классом .card__delete-button не найден в карточке."),i}function n(r){const n=r.target,o=n.dataset.id,c=n.nextElementSibling;var a;c?n.classList.contains("card__like-button_is-active")?(a=o,fetch(`${e.baseUrl}/cards/likes/${a}`,{method:"DELETE",headers:e.headers}).then((e=>t(e)))).then((e=>{c.textContent=e.likes.length,n.classList.remove("card__like-button_is-active")})).catch((e=>console.error("Ошибка при удалении лайка:",e))):function(r){return fetch(`${e.baseUrl}/cards/likes/${r}`,{method:"PUT",headers:e.headers}).then((e=>t(e)))}(o).then((e=>{c.textContent=e.likes.length,n.classList.add("card__like-button_is-active")})).catch((e=>console.error("Ошибка при добавлении лайка:",e))):console.error("Элемент счётчика лайков не найден рядом с кнопкой лайка.")}function o(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",s),e.addEventListener("click",a)}function c(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",s),e.removeEventListener("click",a)}function a(e){e.currentTarget===e.target&&c(e.currentTarget)}function s(e){if("Escape"===e.key){const e=document.querySelector(".popup_is-opened");e&&c(e)}}function l(e,t){const r=Array.from(e.querySelectorAll(t.inputList)),n=e.querySelector(t.buttonElement);r.forEach((r=>{i(e,r,t)})),d(r,n,t)}const i=(e,t,r)=>{const n=e.querySelector(`.${t.id}-error`);t.classList.remove(r.inputErrorClass),n.classList.remove(r.errorClass),n.textContent="",t.setCustomValidity("")},d=(e,t,r)=>{(e=>e.some((e=>!e.validity.valid)))(e)?(t.disabled=!0,t.classList.add(r.buttonElementDisabled)):(t.disabled=!1,t.classList.remove(r.buttonElementDisabled))};function u(e,t){t.textContent=e?"Сохранение...":"Сохранить"}const p=document.querySelector("#card-template").content,_=document.querySelector(".places__list"),m=document.querySelector(".popup_type_image"),y=m.querySelector(".popup__close"),h=m.querySelector(".popup__image"),v=m.querySelector(".popup__caption"),f=document.querySelector(".popup_type_new-card"),b=f.querySelector(".popup__close"),E=document.querySelector(".profile__add-button"),L=document.querySelector(".popup_type_question"),S=L.querySelector(".popup__close"),q=document.querySelector('form[name="card-delete"'),k=document.querySelector(".popup_type_edit"),g=k.querySelector(".popup__close"),C=document.querySelector(".profile__edit-button"),$=document.querySelector(".popup_type_new-avatar"),x=$.querySelector(".popup__close"),D=document.querySelector(".profile__image"),U=document.querySelector(".profile__title"),w=document.querySelector(".profile__description"),T=document.forms["edit-profile"],A=document.forms["new-place"],P=document.forms["avatar-edit"],I=T.elements.name,N=T.elements.description,O=A.elements["place-name"],j=document.getElementById("new-place-url-input"),J=document.getElementById("avatar-url-input");let M;function V(e){if(e.target.classList.contains("card__image")){const t=e.target;h.src=t.src,h.alt=t.alt,v.textContent=t.alt,o(m)}}function B(e,t,r){o(L),q.addEventListener("click",(()=>{t(e).then((()=>{c(L),r.remove()})).catch((e=>{console.log(e),alert("Не удалось удалить карточку. Пожалуйста, попробуйте позже.")}))}),{once:!0})}Promise.all([fetch(`${e.baseUrl}/users/me`,{headers:e.headers}).then((e=>t(e))),fetch(`${e.baseUrl}/cards`,{headers:e.headers}).then((e=>t(e)))]).then((([e,t])=>{M=e._id,D.style.backgroundImage=`url(${e.avatar})`,U.textContent=e.name,w.textContent=e.about;const n=document.createDocumentFragment();t.forEach((e=>{const t=r(e,p,V,M,B);n.appendChild(t)})),_.appendChild(n)})).catch((e=>console.error("Ошибка при загрузке данных:",e))),C.addEventListener("click",(()=>{I.value=U.textContent,N.value=w.textContent,l(k,H),o(k)})),T.addEventListener("submit",(function(r){r.preventDefault();const n=I.value.trim(),o=N.value.trim();if(!n||!o)return void alert("Поля имени и должности не могут быть пустыми.");const a=k.querySelector(".popup__button");var s,l;u(!0,a),(s=n,l=o,fetch(`${e.baseUrl}/users/me`,{method:"PATCH",headers:e.headers,body:JSON.stringify({name:s,about:l})}).then((e=>t(e)))).then((e=>{U.textContent=e.name,w.textContent=e.about,c(k)})).catch((e=>{console.error("Ошибка при обновлении профиля:",e),alert("Не удалось обновить профиль. Пожалуйста, попробуйте позже.")})).finally((()=>{u(!1,a)}))})),g.addEventListener("click",(()=>{T.reset(),c(k)})),A.addEventListener("submit",(function(n){n.preventDefault();const o=O.value.trim(),a=j.value.trim();if(!o||!a)return void alert("Поля названия и ссылки не могут быть пустыми.");const s=A.querySelector(".popup__button");u(!0,s),function(r,n){return fetch(`${e.baseUrl}/cards`,{method:"POST",headers:e.headers,body:JSON.stringify({name:r,link:n})}).then((e=>t(e)))}(o,a).then((e=>{const t=r(e,p,V,M,B);_.prepend(t),A.reset(),l(f,H),c(f)})).catch((e=>{console.error("Ошибка при добавлении карточки:",e),alert("Не удалось добавить карточку. Пожалуйста, попробуйте позже.")})).finally((()=>{u(!1,s)}))})),E.addEventListener("click",(()=>{o(f)})),b.addEventListener("click",(()=>{A.reset(),l(f,H),c(f)})),P.addEventListener("submit",(function(r){r.preventDefault();const n=J.value.trim();if(!n)return void alert("Поле ссылки на аватар не может быть пустым.");const o=$.querySelector(".popup__button");var a;u(!0,o),(a=n,fetch(`${e.baseUrl}/users/me/avatar`,{method:"PATCH",headers:e.headers,body:JSON.stringify({avatar:a})}).then((e=>t(e)))).then((e=>{D.style.backgroundImage=`url('${e.avatar}')`,P.reset(),l(P,H),c($)})).catch((e=>{console.error("Ошибка при обновлении аватара:",e),alert("Не удалось обновить аватар. Пожалуйста, попробуйте позже.")})).finally((()=>{u(!1,o)}))})),D.addEventListener("click",(()=>{o($)})),x.addEventListener("click",(()=>{c($),l(P,H),P.reset()})),y.addEventListener("click",(()=>{c(m)})),S.addEventListener("click",(()=>{c(L)}));const H={formList:".popup__form",inputList:".popup__input",buttonElement:".popup__button",buttonElementDisabled:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"};(e=>{Array.from(document.querySelectorAll(e.formList)).forEach((t=>{t.addEventListener("submit",(e=>{e.preventDefault()})),((e,t)=>{const r=Array.from(e.querySelectorAll(t.inputList)),n=e.querySelector(t.buttonElement);d(r,n,t),r.forEach((o=>{o.addEventListener("input",(function(){((e,t,r)=>{t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),t.validity.valid?i(e,t,r):((e,t,r,n)=>{const o=e.querySelector(`.${t.id}-error`);t.classList.add(n.inputErrorClass),o.textContent=r,o.classList.add(n.errorClass)})(e,t,t.validationMessage,r)})(e,o,t),d(r,n,t)}))}))})(t,e)}))})(H)})();